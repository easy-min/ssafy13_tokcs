{% extends "base.html" %}

{% block title %}객관식 문제 등록 | Tok! CS{% endblock %}

{% block content %}
<div class="content-card">
  <h2>문제 등록 (객관식)</h2>
  <form method="post" id="objectiveQuestionForm">
    {% csrf_token %}
    <!-- 단원 선택: 컨텍스트에 chapters 리스트 전달 (뷰에서) -->
    <div style="margin-bottom:16px;">
      <label for="id_chapter">단원 선택</label>
      <select name="chapter" id="id_chapter" required>
        {% for chapter in chapters %}
          <option value="{{ chapter.id }}">{{ chapter }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- 문제 내용 -->
    <div style="margin-bottom:16px;">
      <label for="id_content">문제 내용</label>
      <textarea name="content" id="id_content" rows="3" required></textarea>
    </div>
    <!-- 문제 해설 -->
    <div style="margin-bottom:16px;">
      <label for="id_explanation">문제 해설</label>
      <textarea name="explanation" id="id_explanation" rows="3"></textarea>
    </div>
    <!-- 배점 -->
    <div style="margin-bottom:16px;">
      <label for="id_score">배점</label>
      <input type="number" name="score" id="id_score" value="5" min="1" required>
    </div>
    
    <h3>선택지 (정답 선택: 라디오 버튼 클릭)</h3>
    <!-- 선택지 입력 영역 -->
    <div id="choicesContainer">
      <!-- 기본 4개 선택지; 첫 번째 선택지가 기본 정답 -->
      <div class="choice-item" data-index="0">
        <input type="radio" name="correct_choice" value="0" checked>
        <input type="text" name="choices[]" placeholder="선택지 내용" required>
        <button type="button" class="removeChoice" onclick="removeChoice(this)">X</button>
      </div>
      <div class="choice-item" data-index="1">
        <input type="radio" name="correct_choice" value="1">
        <input type="text" name="choices[]" placeholder="선택지 내용" required>
        <button type="button" class="removeChoice" onclick="removeChoice(this)">X</button>
      </div>
      <div class="choice-item" data-index="2">
        <input type="radio" name="correct_choice" value="2">
        <input type="text" name="choices[]" placeholder="선택지 내용" required>
        <button type="button" class="removeChoice" onclick="removeChoice(this)">X</button>
      </div>
      <div class="choice-item" data-index="3">
        <input type="radio" name="correct_choice" value="3">
        <input type="text" name="choices[]" placeholder="선택지 내용" required>
        <button type="button" class="removeChoice" onclick="removeChoice(this)">X</button>
      </div>
    </div>
    <!-- 추가 선택지를 위한 + 버튼 -->
    <button type="button" id="addChoiceBtn">+</button>
    
    <div style="margin-top:16px;">
      <button type="submit">문제 등록하기</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 선택지 삭제 함수: 최소 2개는 남아있도록 처리
function removeChoice(btn) {
  const container = document.getElementById('choicesContainer');
  if (container.children.length <= 2) {
    alert("최소 2개의 선택지는 있어야 합니다.");
    return;
  }
  const choiceDiv = btn.parentElement;
  container.removeChild(choiceDiv);
  updateChoiceIndices();
}

// 삭제 후 각 선택지의 인덱스와 라디오 버튼의 값 업데이트
function updateChoiceIndices() {
  const container = document.getElementById('choicesContainer');
  const choiceItems = container.getElementsByClassName('choice-item');
  for (let i = 0; i < choiceItems.length; i++) {
    choiceItems[i].setAttribute('data-index', i);
    const radio = choiceItems[i].querySelector('input[type="radio"]');
    radio.value = i;
  }
}

// 추가 버튼 클릭 시 새로운 선택지 항목 추가 (최대 6개)
document.getElementById('addChoiceBtn').addEventListener('click', function() {
  const container = document.getElementById('choicesContainer');
  if (container.children.length >= 6) {
    alert("최대 6개의 선택지만 입력할 수 있습니다.");
    return;
  }
  const newIndex = container.children.length;
  const div = document.createElement('div');
  div.className = 'choice-item';
  div.setAttribute('data-index', newIndex);
  
  // 라디오 버튼 (정답 지정용)
  const radio = document.createElement('input');
  radio.type = 'radio';
  radio.name = 'correct_choice';
  radio.value = newIndex;
  
  // 텍스트 입력 필드
  const textInput = document.createElement('input');
  textInput.type = 'text';
  textInput.name = 'choices[]';
  textInput.placeholder = '선택지 내용';
  textInput.required = true;
  
  // 삭제 버튼
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.textContent = 'X';
  removeBtn.className = 'removeChoice';
  removeBtn.onclick = function() { removeChoice(removeBtn); };
  
  div.appendChild(radio);
  div.appendChild(textInput);
  div.appendChild(removeBtn);
  
  container.appendChild(div);
});
</script>
{% endblock %}
