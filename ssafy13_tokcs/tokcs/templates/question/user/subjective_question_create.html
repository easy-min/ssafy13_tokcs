{% extends "base.html" %}

{% block title %}주관식 문제 등록 | ToktokCS{% endblock %}

{% block content %}
<div class="card">
  <h1>주관식 문제 입력</h1>
  <form method="post" action="{% url 'create_subjective_quiz' %}" id="subjectiveQuestionForm">
    {% csrf_token %}

    <!-- 주제 선택 -->
    <label for="id_topic">주제</label>
    <select id="id_topic" name="topic" required>
      <option value="">-- 주제 선택 --</option>
      {% for topic in topics %}
        <option value="{{ topic.id }}">{{ topic.name }}</option>
      {% endfor %}
    </select>

    <!-- 단원 선택: Topic 선택 시 Ajax로 동적으로 채워짐 -->
    <label for="chapterContainer">단원 선택</label>
    <div id="chapterContainer" style="margin-bottom:16px;">
      <p class="info">주제를 선택하면 해당 단원 목록이 자동으로 표시됩니다.</p>
    </div>

    <!-- 문제 코드는 자동 생성됨 안내 -->
    <p class="info">문제 코드는 자동 생성됩니다.</p>

    <!-- 질문 내용 -->
    <label for="question_text">질문 내용</label>
    <textarea id="question_text" name="question_text" placeholder="질문 내용을 입력하세요" required></textarea>
    <br>

    <!-- 해설 (선택) -->
    <label for="explanation">해설 (선택)</label>
    <textarea id="explanation" name="explanation" placeholder="문제 해설을 입력하세요"></textarea>
    <br>

    <!-- 배점 -->
    <label for="score">배점</label>
    <input type="number" id="score" name="score" value="5" min="1" required>
    <br>

    <!-- 정답 키워드: 동적으로 추가/삭제 -->
    <label for="keywordContainer">정답 키워드</label>
    <div id="keywordContainer">
      <div class="keyword-item" data-index="0">
        <input type="text" name="keywords[]" placeholder="키워드 1" required>
        <!-- 'X' 버튼 → 클릭 시 해당 항목만 삭제 -->
        <button type="button" onclick="removeKeyword(this)">X</button>
      </div>
    </div>
    <button type="button" id="addKeywordBtn" class="add-btn">키워드 추가하기</button>

    <br>
    <button type="submit">문제 등록</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// -------------------------
// 1) Topic 선택 시 Ajax로 단원 목록 로딩
// -------------------------
document.getElementById('id_topic').addEventListener('change', function() {
  const topicId = this.value;
  const chapterContainer = document.getElementById('chapterContainer');
  chapterContainer.innerHTML = ''; // 초기화
  if (!topicId) return;
  
  fetch("{% url 'get_chapters_by_topic' %}?topic_id=" + topicId)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        chapterContainer.innerHTML = '<p style="color:red;">' + data.error + '</p>';
        return;
      }
      // 받아온 Chapter 목록을 <select>로 생성
      const select = document.createElement('select');
      select.name = 'chapter';
      select.required = true;
      data.chapters.forEach(ch => {
        const option = document.createElement('option');
        option.value = ch.id;
        option.textContent = ch.name;
        select.appendChild(option);
      });
      chapterContainer.appendChild(select);
    })
    .catch(error => {
      chapterContainer.innerHTML = '<p style="color:red;">단원 로드 중 오류 발생</p>';
      console.error("Error fetching chapters:", error);
    });
});

// -------------------------
// 2) 정답 키워드 추가/삭제
// -------------------------
function removeKeyword(button) {
  const container = document.getElementById('keywordContainer');
  const items = container.querySelectorAll('.keyword-item');
  // 최소 1개는 남겨야 함
  if (items.length <= 1) {
    alert("최소 1개의 키워드는 필요합니다.");
    return;
  }
  // 현재 클릭된 'X' 버튼이 속한 .keyword-item만 제거
  const keywordItem = button.closest('.keyword-item');
  if (keywordItem) {
    keywordItem.remove();
  }
  reindexKeywords();
}

function reindexKeywords() {
  const container = document.getElementById('keywordContainer');
  const items = container.querySelectorAll('.keyword-item');
  items.forEach((item, idx) => {
    item.setAttribute('data-index', idx);
    const input = item.querySelector('input[type="text"]');
    input.placeholder = "키워드 " + (idx + 1);
  });
}

// '키워드 추가하기' 버튼 → 새 keyword-item 추가
document.getElementById('addKeywordBtn').addEventListener('click', function() {
  const container = document.getElementById('keywordContainer');
  const items = container.querySelectorAll('.keyword-item');
  // 최대 6개까지 허용
  if (items.length >= 6) {
    alert("최대 6개의 키워드만 추가할 수 있습니다.");
    return;
  }
  const newIndex = items.length;
  // 새 keyword-item div
  const div = document.createElement('div');
  div.className = 'keyword-item';
  div.setAttribute('data-index', newIndex);

  // 텍스트 입력 필드
  const input = document.createElement('input');
  input.type = 'text';
  input.name = 'keywords[]';
  input.required = true;
  input.placeholder = "키워드 " + (newIndex + 1);

  // 'X' 삭제 버튼
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = 'X';
  btn.onclick = function() {
    removeKeyword(btn);
  };

  div.appendChild(input);
  div.appendChild(btn);
  container.appendChild(div);
});
</script>
{% endblock %}
